<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Si√™u Th·ªã ƒêi·ªán T·ª≠ - Fresh Market</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary-color: #4caf50;
        --secondary-color: #81c784;
        --accent-color: #ff9800;
        --bg-light: #f8f9fa;
        --bg-white: #ffffff;
        --text-dark: #2e3a59;
        --text-light: #666;
        --border-color: #e0e0e0;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.15);
        --gradient: linear-gradient(135deg, #4caf50 0%, #81c784 100%);
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg-light);
        color: var(--text-dark);
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      /* Header */
      .header {
        background: var(--gradient);
        color: white;
        padding: 1rem 0;
        box-shadow: var(--shadow);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-size: 1.8rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .cart-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        background: rgba(255, 255, 255, 0.2);
        padding: 0.5rem 1rem;
        border-radius: 25px;
        backdrop-filter: blur(10px);
      }

      .cart-count {
        background: var(--accent-color);
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
      }

      /* Navigation */
      .nav-tabs {
        background: var(--bg-white);
        border-bottom: 1px solid var(--border-color);
        padding: 0;
      }

      .nav-tabs-content {
        display: flex;
        gap: 2rem;
      }

      .nav-tab {
        padding: 1rem 0;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .nav-tab.active {
        border-bottom-color: var(--primary-color);
        color: var(--primary-color);
      }

      /* Main Content */
      .main-content {
        padding: 2rem 0;
      }

      .section {
        display: none;
      }

      .section.active {
        display: block;
      }

      /* Products Grid */
      .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-top: 1rem;
      }

      .product-card {
        background: var(--bg-white);
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .product-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient);
        transform: scaleX(0);
        transition: transform 0.3s ease;
      }

      .product-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-hover);
      }

      .product-card:hover::before {
        transform: scaleX(1);
      }

      .product-icon {
        font-size: 3rem;
        text-align: center;
        margin-bottom: 1rem;
        color: var(--primary-color);
      }

      .product-name {
        font-size: 1.2rem;
        font-weight: 600;
        text-align: center;
        margin-bottom: 0.5rem;
      }

      .product-price {
        font-size: 1.1rem;
        font-weight: bold;
        color: var(--accent-color);
        text-align: center;
        margin-bottom: 1rem;
      }

      .quantity-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .quantity-btn {
        width: 35px;
        height: 35px;
        border: 2px solid var(--primary-color);
        background: var(--bg-white);
        color: var(--primary-color);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.2rem;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .quantity-btn:hover {
        background: var(--primary-color);
        color: white;
        transform: scale(1.1);
      }

      .quantity-display {
        font-size: 1.2rem;
        font-weight: bold;
        min-width: 40px;
        text-align: center;
        background: var(--bg-light);
        padding: 0.5rem;
        border-radius: 8px;
      }

      .add-to-cart-btn {
        width: 100%;
        padding: 0.8rem;
        background: var(--gradient);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .add-to-cart-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      }

      .add-to-cart-btn:active {
        transform: translateY(0);
      }

      /* Checkout Button */
      .checkout-section {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
      }

      .checkout-btn {
        background: var(--gradient);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 50px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        box-shadow: var(--shadow-hover);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .checkout-btn:hover {
        transform: scale(1.05);
      }

      .checkout-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Forms */
      .form-container {
        background: var(--bg-white);
        border-radius: 15px;
        padding: 2rem;
        box-shadow: var(--shadow);
      }

      .form-title {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 1.5rem;
        color: var(--text-dark);
        text-align: center;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text-dark);
      }

      .form-input {
        width: 100%;
        padding: 0.8rem;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
      }

      .form-select {
        width: 100%;
        padding: 0.8rem;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        font-size: 1rem;
        background: var(--bg-white);
        cursor: pointer;
      }

      /* Buttons */
      .btn {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn-primary {
        background: var(--gradient);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      }

      .btn-secondary {
        background: var(--bg-light);
        color: var(--text-dark);
        border: 2px solid var(--border-color);
      }

      .btn-secondary:hover {
        background: var(--border-color);
      }

      .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: space-between;
        margin-top: 2rem;
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        z-index: 2000;
        animation: fadeIn 0.3s ease;
      }

      .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: var(--bg-white);
        border-radius: 20px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease;
      }

      .modal-header {
        text-align: center;
        margin-bottom: 1.5rem;
      }

      .modal-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--text-dark);
      }

      .modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1.5rem;
      }

      /* Invoice */
      .invoice {
        background: var(--bg-white);
        border-radius: 15px;
        padding: 2rem;
        box-shadow: var(--shadow);
        border: 2px solid var(--border-color);
      }

      .invoice-header {
        text-align: center;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
      }

      .invoice-title {
        font-size: 1.8rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
      }

      .invoice-number {
        font-size: 1rem;
        color: var(--text-light);
      }

      .invoice-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .invoice-section {
        background: var(--bg-light);
        padding: 1rem;
        border-radius: 10px;
      }

      .invoice-section-title {
        font-weight: bold;
        margin-bottom: 0.5rem;
        color: var(--text-dark);
      }

      .invoice-items {
        margin-bottom: 1.5rem;
      }

      .invoice-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-color);
      }

      .invoice-item:last-child {
        border-bottom: none;
      }

      .invoice-total {
        text-align: right;
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--primary-color);
        border-top: 2px solid var(--border-color);
        padding-top: 1rem;
      }

      .tracking-code {
        background: var(--gradient);
        color: white;
        padding: 1rem;
        border-radius: 15px;
        text-align: center;
        margin: 1.5rem 0;
      }

      .tracking-code-title {
        font-size: 1rem;
        margin-bottom: 0.5rem;
      }

      .tracking-code-number {
        font-size: 1.5rem;
        font-weight: bold;
        letter-spacing: 2px;
        font-family: "Courier New", monospace;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .products-grid {
          grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
          gap: 1rem;
        }

        .header-content {
          flex-direction: column;
          gap: 1rem;
        }

        .nav-tabs-content {
          gap: 1rem;
        }

        .invoice-details {
          grid-template-columns: 1fr;
        }

        .form-actions {
          flex-direction: column;
        }

        .checkout-section {
          position: relative;
          bottom: auto;
          right: auto;
          margin-top: 2rem;
          text-align: center;
        }
      }

      /* Animations */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-50px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header" id="main-header">
      <div class="container">
        <div class="header-content">
          <div class="logo">
            <i class="fas fa-shopping-cart"></i>
            Fresh Market
          </div>
          <div class="cart-info">
            <i class="fas fa-shopping-basket"></i>
            <span id="cart-count" class="cart-count">0</span>
            <span id="cart-total">0‚Ç´</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="nav-tabs" id="main-navigation">
      <div class="container">
        <div class="nav-tabs-content">
          <div class="nav-tab active" data-section="products">
            <i class="fas fa-store"></i> S·∫£n ph·∫©m
          </div>
          <div class="nav-tab" data-section="checkout">
            <i class="fas fa-credit-card"></i> Thanh to√°n
          </div>
          <div class="nav-tab" data-section="shipping">
            <i class="fas fa-truck"></i> Giao h√†ng
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="container">
        <!-- Products Section -->
        <section id="products-section" class="section active">
          <div class="products-grid" id="products-grid">
            <!-- Products will be dynamically loaded here -->
          </div>
          <div class="checkout-section">
            <button id="proceed-checkout-btn" class="checkout-btn" disabled>
              <i class="fas fa-arrow-right"></i>
              ƒê·∫∑t h√†ng (<span id="checkout-count">0</span>)
            </button>
          </div>
        </section>

        <!-- Checkout Section -->
        <section id="checkout-section" class="section">
          <div class="form-container">
            <h2 class="form-title">Th√¥ng tin ƒë·∫∑t h√†ng</h2>
            <form id="checkout-form">
              <div class="form-group">
                <label class="form-label">H·ªç v√† t√™n *</label>
                <input
                  type="text"
                  id="customer-name"
                  class="form-input"
                  required
                />
              </div>
              <div class="form-group">
                <label class="form-label">S·ªë ƒëi·ªán tho·∫°i *</label>
                <input
                  type="tel"
                  id="customer-phone"
                  class="form-input"
                  required
                />
              </div>
              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="customer-email" class="form-input" />
              </div>
              <div class="form-group">
                <label class="form-label">ƒê·ªãa ch·ªâ giao h√†ng *</label>
                <textarea
                  id="customer-address"
                  class="form-input"
                  rows="3"
                  required
                ></textarea>
              </div>
              <div class="form-group">
                <label class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n *</label>
                <select id="payment-method" class="form-select" required>
                  <option value="">Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n</option>
                  <option value="cod">Thanh to√°n khi nh·∫≠n h√†ng (COD)</option>
                  <option value="bank">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</option>
                  <option value="momo">V√≠ ƒëi·ªán t·ª≠ MoMo</option>
                  <option value="zaloPay">ZaloPay</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Ghi ch√∫</label>
                <textarea
                  id="order-notes"
                  class="form-input"
                  rows="2"
                  placeholder="Ghi ch√∫ ƒë·∫∑c bi·ªát cho ƒë∆°n h√†ng..."
                ></textarea>
              </div>
              <div class="form-actions">
                <button
                  type="button"
                  class="btn btn-secondary"
                  id="back-to-products"
                >
                  <i class="fas fa-arrow-left"></i> Quay l·∫°i
                </button>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-check"></i> X√°c nh·∫≠n ƒë·∫∑t h√†ng
                </button>
              </div>
            </form>
          </div>
        </section>

        <!-- Shipping Section -->
        <section id="shipping-section" class="section">
          <div class="form-container">
            <h2 class="form-title">X√°c nh·∫≠n giao h√†ng</h2>
            <div id="order-summary">
              <!-- Order summary will be displayed here -->
            </div>
            <div class="form-actions">
              <button
                type="button"
                class="btn btn-secondary"
                id="back-to-checkout"
              >
                <i class="fas fa-arrow-left"></i> Quay l·∫°i
              </button>
              <button
                type="button"
                class="btn btn-primary"
                id="confirm-delivery"
              >
                <i class="fas fa-truck"></i> X√°c nh·∫≠n giao h√†ng
              </button>
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="modal-title">X√°c nh·∫≠n</h3>
        </div>
        <div id="modal-body">
          <!-- Modal content will be dynamically inserted -->
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="modal-cancel">
            H·ªßy
          </button>
          <button type="button" class="btn btn-primary" id="modal-confirm">
            X√°c nh·∫≠n
          </button>
        </div>
      </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoice-modal" class="modal">
      <div class="modal-content">
        <div class="invoice" id="invoice-content">
          <!-- Invoice will be generated here -->
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="download-invoice">
            <i class="fas fa-download"></i> T·∫£i xu·ªëng
          </button>
          <button type="button" class="btn btn-primary" id="back-to-home">
            <i class="fas fa-home"></i> V·ªÅ trang ch·ªß
          </button>
        </div>
      </div>
    </div>
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyB8AZIshstjF9yP2VUGfw_8o2zJ61P9IOw",
        authDomain: "e-commercemarket-iot.firebaseapp.com",
        databaseURL:
          "https://e-commercemarket-iot-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "e-commercemarket-iot",
        storageBucket: "e-commercemarket-iot.firebasestorage.app",
        messagingSenderId: "674706909277",
        appId: "1:674706909277:web:b9c6e1662f9f9f539d05b4",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
    </script>
    <script>
      // Initialize Firebase (commented out for demo without a real database)
      // try {
      //     firebase.initializeApp(firebaseConfig);
      //     const database = firebase.database();
      // } catch (e) {
      //     console.error("Firebase initialization failed. Using mock data.", e);
      // }

      /**
       * Main application class following an OOP pattern.
       * Manages state, UI rendering, and user interactions for the e-commerce platform.
       */
      class SupermarketApp {
        constructor() {
          this.products = [];
          this.cart = [];
          this.currentOrder = null;
          this.currentSection = "products";

          this.initializeProducts();
          this.initializeEventListeners();
          this.renderProducts();
          this.updateCartDisplay();
        }

        // SECTION: INITIALIZATION

        /**
         * Initializes the product list. In a real application, this would fetch from a database.
         */
        initializeProducts() {
          this.products = [
            {
              id: 1,
              name: "B√†n ch·∫£i ƒë√°nh rƒÉng",
              price: 25000,
              icon: "ü™•",
              category: "personal_care",
            },
            {
              id: 2,
              name: "C√° t∆∞∆°i",
              price: 150000,
              icon: "üêü",
              category: "seafood",
            },
            {
              id: 3,
              name: "Th·ªãt b√≤",
              price: 300000,
              icon: "ü•©",
              category: "meat",
            },
            {
              id: 4,
              name: "Tr·ª©ng g√†",
              price: 45000,
              icon: "ü•ö",
              category: "dairy",
            },
            {
              id: 5,
              name: "R∆∞·ª£u vang ƒë·ªè",
              price: 250000,
              icon: "üç∑",
              category: "beverages",
            },
            {
              id: 6,
              name: "Kem",
              price: 80000,
              icon: "üç¶",
              category: "frozen",
            },
            {
              id: 7,
              name: "Rau c·∫£i",
              price: 20000,
              icon: "ü•¨",
              category: "vegetables",
            },
            {
              id: 8,
              name: "Khoai t√¢y",
              price: 30000,
              icon: "ü•î",
              category: "vegetables",
            },
            {
              id: 9,
              name: "Bim bim",
              price: 15000,
              icon: "üçø",
              category: "snacks",
            },
            {
              id: 10,
              name: "C√† ph√™ Trung Nguy√™n",
              price: 120000,
              icon: "‚òï",
              category: "beverages",
            },
            {
              id: 11,
              name: "B√°nh m√¨",
              price: 10000,
              icon: "üçû",
              category: "bakery",
            },
            {
              id: 12,
              name: "S·ªØa t∆∞∆°i",
              price: 25000,
              icon: "ü•õ",
              category: "dairy",
            },
            {
              id: 13,
              name: "T√°o",
              price: 60000,
              icon: "üçé",
              category: "fruits",
            },
            {
              id: 14,
              name: "Chu·ªëi",
              price: 25000,
              icon: "üçå",
              category: "fruits",
            },
            {
              id: 15,
              name: "G·∫°o",
              price: 45000,
              icon: "üçö",
              category: "grains",
            },
            {
              id: 16,
              name: "D·∫ßu ƒÉn",
              price: 35000,
              icon: "ü´í",
              category: "condiments",
            },
            {
              id: 17,
              name: "N∆∞·ªõc su·ªëi",
              price: 8000,
              icon: "üíß",
              category: "beverages",
            },
            {
              id: 18,
              name: "B√°nh quy",
              price: 40000,
              icon: "üç™",
              category: "snacks",
            },
            {
              id: 19,
              name: "M√¨ t√¥m",
              price: 5000,
              icon: "üçú",
              category: "instant",
            },
            {
              id: 20,
              name: "T√¥m t∆∞∆°i",
              price: 200000,
              icon: "ü¶ê",
              category: "seafood",
            },
          ];
        }

        /**
         * Sets up all global event listeners for the application.
         */
        initializeEventListeners() {
          document.querySelectorAll(".nav-tab").forEach((tab) => {
            tab.addEventListener("click", (e) =>
              this.navigateToSection(e.currentTarget.dataset.section)
            );
          });
          document
            .getElementById("proceed-checkout-btn")
            .addEventListener("click", () => {
              this.showConfirmationModal(
                "X√°c nh·∫≠n ƒë·∫∑t h√†ng",
                "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c ƒë·∫∑t h√†ng?",
                () => this.navigateToSection("checkout")
              );
            });
          document
            .getElementById("checkout-form")
            .addEventListener("submit", (e) => {
              e.preventDefault();
              this.handleCheckoutSubmit();
            });
          document
            .getElementById("back-to-products")
            .addEventListener("click", () =>
              this.navigateToSection("products")
            );
          document
            .getElementById("back-to-checkout")
            .addEventListener("click", () =>
              this.navigateToSection("checkout")
            );
          document
            .getElementById("confirm-delivery")
            .addEventListener("click", () => this.handleDeliveryConfirmation());
          document
            .getElementById("modal-cancel")
            .addEventListener("click", () =>
              this.hideModal("confirmation-modal")
            );
          document
            .getElementById("download-invoice")
            .addEventListener("click", () => this.downloadInvoice());
          document
            .getElementById("back-to-home")
            .addEventListener("click", () => this.resetApplication());
        }

        // SECTION: PRODUCT & CART LOGIC

        /**
         * Renders all products to the main grid.
         */
        renderProducts() {
          const grid = document.getElementById("products-grid");
          grid.innerHTML = "";
          this.products.forEach((product) => {
            const productCard = this.createProductCard(product);
            grid.appendChild(productCard);
          });
        }

        /**
         * Creates the HTML element for a single product card.
         * @param {object} product - The product data.
         * @returns {HTMLElement} The product card element.
         */
        createProductCard(product) {
          const card = document.createElement("div");
          card.className = "product-card";
          card.innerHTML = `
                    <div class="product-icon">${product.icon}</div>
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">${this.formatCurrency(
                      product.price
                    )}</div>
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="app.updateQuantity(${
                          product.id
                        }, -1)">‚àí</button>
                        <div class="quantity-display" id="quantity-${
                          product.id
                        }">0</div>
                        <button class="quantity-btn" onclick="app.updateQuantity(${
                          product.id
                        }, 1)">+</button>
                    </div>
                    <button class="add-to-cart-btn" onclick="app.addToCart(${
                      product.id
                    })">
                        <i class="fas fa-cart-plus"></i> Th√™m v√†o gi·ªè
                    </button>
                `;
          return card;
        }

        /**
         * Updates the quantity selector for a given product.
         * @param {number} productId - The ID of the product.
         * @param {number} change - The amount to change the quantity by (+1 or -1).
         */
        updateQuantity(productId, change) {
          const quantityEl = document.getElementById(`quantity-${productId}`);
          let currentQuantity = parseInt(quantityEl.textContent, 10);
          currentQuantity = Math.max(0, currentQuantity + change);
          quantityEl.textContent = currentQuantity;
        }

        /**
         * Adds a product to the shopping cart based on the selected quantity.
         * @param {number} productId - The ID of the product to add.
         */
        addToCart(productId) {
          const quantityEl = document.getElementById(`quantity-${productId}`);
          const quantity = parseInt(quantityEl.textContent, 10);

          if (quantity <= 0) {
            this.showToast("Vui l√≤ng ch·ªçn s·ªë l∆∞·ª£ng l·ªõn h∆°n 0.", "error");
            return;
          }

          const product = this.products.find((p) => p.id === productId);
          if (!product) return;

          const cartItem = this.cart.find((item) => item.id === productId);
          if (cartItem) {
            cartItem.quantity += quantity;
          } else {
            this.cart.push({ ...product, quantity });
          }

          quantityEl.textContent = "0";
          this.updateCartDisplay();
          this.showToast(`${product.name} ƒë√£ ƒë∆∞·ª£c th√™m v√†o gi·ªè h√†ng.`);
        }

        /**
         * Updates all UI elements related to the cart (counts, totals).
         */
        updateCartDisplay() {
          const cartCountEl = document.getElementById("cart-count");
          const cartTotalEl = document.getElementById("cart-total");
          const checkoutCountEl = document.getElementById("checkout-count");
          const proceedCheckoutBtn = document.getElementById(
            "proceed-checkout-btn"
          );

          const totalItems = this.cart.reduce(
            (sum, item) => sum + item.quantity,
            0
          );
          const totalPrice = this.cart.reduce(
            (sum, item) => sum + item.price * item.quantity,
            0
          );

          cartCountEl.textContent = totalItems;
          checkoutCountEl.textContent = totalItems;
          cartTotalEl.textContent = this.formatCurrency(totalPrice);
          proceedCheckoutBtn.disabled = totalItems === 0;
        }

        // SECTION: NAVIGATION & PAGE FLOW

        /**
         * Handles navigation between the main sections of the application.
         * @param {string} sectionName - The name of the section to navigate to.
         */
        navigateToSection(sectionName) {
          if (sectionName === "checkout" && this.cart.length === 0) {
            this.showToast("Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.", "error");
            return;
          }

          this.currentSection = sectionName;
          document
            .querySelectorAll(".section")
            .forEach((s) => s.classList.remove("active"));
          document
            .querySelectorAll(".nav-tab")
            .forEach((t) => t.classList.remove("active"));

          document
            .getElementById(`${sectionName}-section`)
            .classList.add("active");
          document
            .querySelector(`.nav-tab[data-section="${sectionName}"]`)
            .classList.add("active");

          if (sectionName === "shipping") {
            this.renderOrderSummary();
          }
        }

        /**
         * Processes the checkout form, creates an order object, and moves to the shipping confirmation step.
         */
        handleCheckoutSubmit() {
          const form = document.getElementById("checkout-form");
          if (!form.checkValidity()) {
            form.reportValidity();
            return;
          }

          this.currentOrder = {
            customer: {
              name: document.getElementById("customer-name").value,
              phone: document.getElementById("customer-phone").value,
              email: document.getElementById("customer-email").value,
              address: document.getElementById("customer-address").value,
            },
            paymentMethod: document.getElementById("payment-method").value,
            notes: document.getElementById("order-notes").value,
            items: [...this.cart],
            total: this.cart.reduce(
              (sum, item) => sum + item.price * item.quantity,
              0
            ),
            orderDate: new Date(),
          };

          this.navigateToSection("shipping");
        }

        /**
         * Renders the final order summary before the user confirms delivery.
         */
        renderOrderSummary() {
          if (!this.currentOrder) return;
          const summaryEl = document.getElementById("order-summary");
          const { customer, items, total, paymentMethod } = this.currentOrder;

          const itemsHtml = items
            .map(
              (item) => `
                    <div class="invoice-item">
                        <span>${item.name} (x${item.quantity})</span>
                        <span>${this.formatCurrency(
                          item.price * item.quantity
                        )}</span>
                    </div>
                `
            )
            .join("");

          summaryEl.innerHTML = `
                    <div class="invoice">
                        <div class="invoice-details">
                            <div class="invoice-section">
                                <div class="invoice-section-title">Th√¥ng tin kh√°ch h√†ng</div>
                                <p><strong>T√™n:</strong> ${customer.name}</p>
                                <p><strong>SƒêT:</strong> ${customer.phone}</p>
                                <p><strong>ƒê·ªãa ch·ªâ:</strong> ${
                                  customer.address
                                }</p>
                            </div>
                            <div class="invoice-section">
                                <div class="invoice-section-title">Th√¥ng tin ƒë∆°n h√†ng</div>
                                <p><strong>Thanh to√°n:</strong> ${paymentMethod}</p>
                                <p><strong>T·ªïng ti·ªÅn:</strong> ${this.formatCurrency(
                                  total
                                )}</p>
                            </div>
                        </div>
                        <div class="invoice-items">${itemsHtml}</div>
                        <div class="invoice-total">T·ªïng c·ªông: ${this.formatCurrency(
                          total
                        )}</div>
                    </div>
                `;
        }

        /**
         * Handles the final delivery confirmation, "saves" the order, and generates the invoice.
         */
        handleDeliveryConfirmation() {
          this.showConfirmationModal(
            "X√°c nh·∫≠n giao h√†ng",
            "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√°c nh·∫≠n v√† g·ª≠i ƒë∆°n h√†ng n√†y ƒëi?",
            () => {
              const confirmBtn = document.getElementById("confirm-delivery");
              confirmBtn.innerHTML =
                '<span class="loading"></span> ƒêang x·ª≠ l√Ω...';
              confirmBtn.disabled = true;

              this.saveOrderToFirebase(this.currentOrder)
                .then((orderId) => {
                  this.currentOrder.id = orderId;
                  setTimeout(() => {
                    // Simulate processing time
                    this.generateInvoice();
                    this.hideModal("confirmation-modal");
                    this.showModal("invoice-modal");
                    confirmBtn.innerHTML =
                      '<i class="fas fa-truck"></i> X√°c nh·∫≠n giao h√†ng';
                    confirmBtn.disabled = false;
                  }, 1500);
                })
                .catch((error) => {
                  this.showToast("C√≥ l·ªói x·∫£y ra khi l∆∞u ƒë∆°n h√†ng.", "error");
                  console.error("Order save error:", error);
                  confirmBtn.innerHTML =
                    '<i class="fas fa-truck"></i> X√°c nh·∫≠n giao h√†ng';
                  confirmBtn.disabled = false;
                });
            }
          );
        }

        /**
         * Saves the order to Firebase. Returns a promise with the order ID.
         * @param {object} order - The order object to save.
         * @returns {Promise<string>} A promise that resolves with the new order's ID.
         */
        saveOrderToFirebase(order) {
          return new Promise((resolve, reject) => {
            // This is where you would interact with a real Firebase database.
            // For this demo, we'll simulate it.
            if (typeof firebase !== "undefined" && firebase.database) {
              // const ordersRef = firebase.database().ref('orders');
              // const newOrderRef = ordersRef.push();
              // newOrderRef.set(order)
              //     .then(() => resolve(newOrderRef.key))
              //     .catch(error => reject(error));
            } else {
              // Simulate success without Firebase
              console.log("Simulating order save:", order);
              const mockId = `FM-${Date.now()}`;
              resolve(mockId);
            }
          });
        }

        // SECTION: INVOICE & MODALS

        /**
         * Generates the final invoice HTML and displays it in a modal.
         */
        generateInvoice() {
          if (!this.currentOrder) return;
          const invoiceContentEl = document.getElementById("invoice-content");
          const { id, customer, items, total, paymentMethod, orderDate } =
            this.currentOrder;

          const itemsHtml = items
            .map(
              (item) => `
                    <div class="invoice-item">
                        <span>${item.name} (x${item.quantity})</span>
                        <span>${this.formatCurrency(
                          item.price * item.quantity
                        )}</span>
                    </div>
                `
            )
            .join("");

          invoiceContentEl.innerHTML = `
                    <div class="invoice-header">
                        <h2 class="invoice-title">H√≥a ƒê∆°n B√°n L·∫ª</h2>
                        <p class="invoice-number">M√£ ƒë∆°n: ${id}</p>
                    </div>
                    <div class="tracking-code">
                        <div class="tracking-code-title">M√£ tra c·ª©u ƒë∆°n h√†ng c·ªßa b·∫°n</div>
                        <div class="tracking-code-number">${id}</div>
                    </div>
                    <div class="invoice-details">
                        <div class="invoice-section">
                            <div class="invoice-section-title">Th√¥ng tin kh√°ch h√†ng</div>
                            <p><strong>T√™n:</strong> ${customer.name}</p>
                            <p><strong>SƒêT:</strong> ${customer.phone}</p>
                            <p><strong>ƒê·ªãa ch·ªâ:</strong> ${customer.address}</p>
                        </div>
                        <div class="invoice-section">
                            <div class="invoice-section-title">Th√¥ng tin ƒë∆°n h√†ng</div>
                            <p><strong>Ng√†y ƒë·∫∑t:</strong> ${new Date(
                              orderDate
                            ).toLocaleDateString("vi-VN")}</p>
                            <p><strong>Thanh to√°n:</strong> ${paymentMethod}</p>
                        </div>
                    </div>
                    <div class="invoice-items">
                        <div class="invoice-item" style="font-weight: bold; border-bottom: 2px solid var(--text-dark);">
                            <span>S·∫£n ph·∫©m</span>
                            <span>Th√†nh ti·ªÅn</span>
                        </div>
                        ${itemsHtml}
                    </div>
                    <div class="invoice-total">
                        T·ªïng c·ªông: ${this.formatCurrency(total)}
                    </div>
                `;
        }

        /**
         * Opens the invoice for printing or saving as PDF.
         */
        downloadInvoice() {
          const invoiceContent =
            document.getElementById("invoice-content").innerHTML;
          const styles = document.querySelector("style").innerHTML;
          const printWindow = window.open("", "", "height=800,width=800");

          printWindow.document.write(
            "<html><head><title>H√≥a ƒê∆°n Fresh Market</title>"
          );
          printWindow.document.write("<style>" + styles + "</style>");
          printWindow.document.write("</head><body>");
          printWindow.document.write(invoiceContent);
          printWindow.document.write("</body></html>");

          printWindow.document.close();
          printWindow.focus();

          setTimeout(() => {
            printWindow.print();
            printWindow.close();
          }, 500);
        }

        /**
         * Resets the application to its initial state after an order is complete.
         */
        resetApplication() {
          this.cart = [];
          this.currentOrder = null;
          this.updateCartDisplay();
          this.hideModal("invoice-modal");
          this.navigateToSection("products");
          document.getElementById("checkout-form").reset();
        }

        // SECTION: UI HELPERS (Modals, Toasts, Formatters)

        /**
         * Shows a modal dialog.
         * @param {string} modalId - The ID of the modal element to show.
         */
        showModal(modalId) {
          document.getElementById(modalId).classList.add("active");
        }

        /**
         * Hides a modal dialog.
         * @param {string} modalId - The ID of the modal element to hide.
         */
        hideModal(modalId) {
          document.getElementById(modalId).classList.remove("active");
        }

        /**
         * Displays a generic confirmation modal with a dynamic title, body, and callback.
         * @param {string} title - The title of the modal.
         * @param {string} body - The HTML content for the modal body.
         * @param {function} onConfirm - The callback function to execute when confirmed.
         */
        showConfirmationModal(title, body, onConfirm) {
          document.getElementById("modal-title").textContent = title;
          document.getElementById("modal-body").innerHTML = `<p>${body}</p>`;

          const confirmBtn = document.getElementById("modal-confirm");
          const newConfirmBtn = confirmBtn.cloneNode(true); // Clone to remove old listeners
          confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

          newConfirmBtn.addEventListener(
            "click",
            () => {
              onConfirm();
              this.hideModal("confirmation-modal");
            },
            { once: true }
          ); // Ensure the event fires only once

          this.showModal("confirmation-modal");
        }

        /**
         * Displays a short-lived toast notification.
         * @param {string} message - The message to display.
         * @param {string} type - The type of toast ('success' or 'error').
         */
        showToast(message, type = "success") {
          const toast = document.createElement("div");
          toast.className = "toast-notification";
          toast.textContent = message;
          if (type === "error") {
            toast.style.backgroundColor = "#E53935"; // A red color for errors
          }
          document.body.appendChild(toast);

          const styleId = "toast-styles";
          if (!document.getElementById(styleId)) {
            const style = document.createElement("style");
            style.id = styleId;
            style.innerHTML = `
                    .toast-notification {
                        position: fixed;
                        bottom: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        background-color: var(--accent-color);
                        color: white;
                        padding: 1rem 2rem;
                        border-radius: 25px;
                        box-shadow: var(--shadow-hover);
                        z-index: 3000;
                        animation: toast-in 0.5s ease, toast-out 0.5s ease 2.5s forwards;
                    }
                    @keyframes toast-in { from { bottom: -100px; opacity: 0; } to { bottom: 20px; opacity: 1; } }
                    @keyframes toast-out { from { bottom: 20px; opacity: 1; } to { bottom: -100px; opacity: 0; } }
                    `;
            document.head.appendChild(style);
          }

          setTimeout(() => toast.remove(), 3000);
        }

        /**
         * Formats a number into Vietnamese currency format.
         * @param {number} amount - The number to format.
         * @returns {string} The formatted currency string.
         */
        formatCurrency(amount) {
          return new Intl.NumberFormat("vi-VN", {
            style: "currency",
            currency: "VND",
          }).format(amount);
        }
      }

      // Create and start the application instance when the DOM is ready.
      document.addEventListener("DOMContentLoaded", () => {
        window.app = new SupermarketApp();
      });
    </script>
  </body>
</html>
